<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Visual Studio 挖坑记 - free()"><meta name="keywords" content="C/C++,free,Visual Studio,坑"><meta name="author" content="alldo,undefined"><meta name="copyright" content="alldo"><title>Visual Studio 挖坑记 - free() | 北冥鱼饵</title><link rel="shortcut icon" href="/my-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#问题：free函数调用后程序空转"><span class="toc-number">1.</span> <span class="toc-text">问题：free函数调用后程序空转</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#不可行的解决方法"><span class="toc-number">2.</span> <span class="toc-text">不可行的解决方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#想法"><span class="toc-number">3.</span> <span class="toc-text">想法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#错误确定与解决方案"><span class="toc-number">4.</span> <span class="toc-text">错误确定与解决方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#后记"><span class="toc-number">5.</span> <span class="toc-text">后记</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">alldo</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">1</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">4</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://r.photo.store.qq.com/psb?/V146EW4F0bCCEJ/RTpw949qMEPzpK5HUALSqOSH9xfqbbzSDCzFNTFe6Xg!/r/dFUAAAAAAAAA)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">北冥鱼饵</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/tags">标签</a></span></div><div id="post-info"><div id="post-title">Visual Studio 挖坑记 - free()</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-09-23</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="问题：free函数调用后程序空转"><a href="#问题：free函数调用后程序空转" class="headerlink" title="问题：free函数调用后程序空转"></a>问题：free函数调用后程序空转</h2><p>今天，我在使用<code>VS</code>做数据结构相关开发时遇到了一个<code>bug</code>。<br><code>bug</code>的内容就是，当你显式的销毁刚刚开辟的动态空间时，大多数情况下，均可销毁成功。存在一种特殊情况下，VS虽然不会报错，但是进入了一个<strong>空运转</strong>。<br><a id="more"></a><br>下面是调试过程中断点前后的截图：<br><img src="https://r.photo.store.qq.com/psb?/V146EW4F0bCCEJ/N*NKkTYPk10a3H.FS17enYrUakxoDzqwqfaFmjVyaQw!/r/dFQBAAAAAAAA" alt="断点之前"><br><img src="https://r.photo.store.qq.com/psb?/V146EW4F0bCCEJ/U0JJdRJEU4XlXkV47lCjoyK2c9fOUpQQXSXpNb7DFRI!/r/dDIBAAAAAAAA" alt="断点之后"><br>经过<code>断点</code>后，没有任何事情发生，程序进而空运，除了暂停和终止，不能进行任何操作（<em>通常情况下，逐语句，逐过程，跳出应该可以正常工作</em>）。</p>
<h2 id="不可行的解决方法"><a href="#不可行的解决方法" class="headerlink" title="不可行的解决方法"></a>不可行的解决方法</h2><p>立马，我在网上搜索答案，几乎全部内容说是内存越界，那我仔细回看我的代码，我发现并没有内存越界的错误。<br><img src="https://r.photo.store.qq.com/psb?/V146EW4F0bCCEJ/9GONkZOiivZwFGV336fLxwsCJKTL6Jo9ct.NeIvNgCo!/r/dFMBAAAAAAAA" alt="不可行的解决方法 "><br>我用<code>sizeof</code>，找到了我赋值的内存，和我开辟空间的内存，我发现他们都是<code>4</code>（在64位的系统，这个数值可能是8）既然他们的内存大小相同，那么我们去释放的时候，它的内存应该不会越界。  </p>
<h2 id="想法"><a href="#想法" class="headerlink" title="想法"></a>想法</h2><p>于是我考虑会不会是VS的内部错误？而并非是我本身的编码。于是我立马打开了我的云端环境linux（它有标准c的编译器-<code>gcc5.4.0</code>）<br><img src="https://r.photo.store.qq.com/psb?/V146EW4F0bCCEJ/AbTVLz9WXrteqQ1QFL1HHu.BOGZsTykXBHSgrWMI*9Q!/r/dDUBAAAAAAAA" alt="想法"><br>编译时没有报错，并且可以<strong>正确运行</strong>没有陷入空转。    </p>
<h2 id="错误确定与解决方案"><a href="#错误确定与解决方案" class="headerlink" title="错误确定与解决方案"></a>错误确定与解决方案</h2><p>既然没有内存越界，应该是内部的问题，我去寻找内部的一些<code>next</code>指针发现了一些猫腻在里面，其中在<code>s</code>这个next指针最后指向的是一个NULL。<br><img src="https://r.photo.store.qq.com/psb?/V146EW4F0bCCEJ/oY3GgTo.DAb1Dl.uPjn9wWDADp5Bwn3psiFQh9ZPOvk!/r/dFIBAAAAAAAA" alt="错误确定与解决方案 "><br>我们动态开辟了一个可以释放的内存空间<code>k</code>，发现<code>k</code>的next指向的是一个等待赋值的内存空间，我们把<code>k-&gt;next</code>赋值给<code>s-&gt;next</code>再去释放s的空间，可以发现释放空间没有进入空转状态。<br><img src="https://r.photo.store.qq.com/psb?/V146EW4F0bCCEJ/Enn*6lWRXj59GrrJXJm2pidtscoQBrxrNatOyuw7ZEY!/r/dDYBAAAAAAAA" alt="错误确定与解决方案 "><br>于是我比对了我的k和s，他们的内存状况，我发现当我开辟k的时候，VS会给他自动分配一个地址0xcdcdcdcd，而我给s赋值的时候，这个地址是原来的值NULL，这样一来的话，在调用free函数，就会陷入空转。<br>解决方案：  </p>
<blockquote>
<p><strong>开辟了一块辅助空间k，将k下next赋值给了s下的next，使得s下的next成为一块带开辟的空间。最后对s与k调用free函数，成功的释放了空间，问题得以解决。</strong>   </p>
</blockquote>
<p><img src="https://r.photo.store.qq.com/psb?/V146EW4F0bCCEJ/gHgnxUm.qJIPdFOILxRFTgLP.tvBxsBOUQ7c9HPJ2*M!/r/dEgBAAAAAAAA" alt="问题得以解决">  </p>
<blockquote>
<p>ps:为什么我的程序没有一闪而过？ 不要也不习惯写<code>system(&quot;pause&quot;);</code>是一种 a bad way ,我们只需要在需要暂停的地方打一个<code>BreakPoint</code>即可。</p>
</blockquote>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p><img src="https://r.photo.store.qq.com/psb?/V146EW4F0bCCEJ/paMSc3bEwsWFyLlUMF*X7cePUSo4q*x8DlrJ9gIJC7k!/r/dDMBAAAAAAAA" alt="bug提交到VS"><br><em>我我已经将bug提交到VS。</em><br>VS中遇到的一些问题，网上的教程非常少，可能或许本身，就不是你的错，通过这次遭遇，我提高了调试代码的能力和解决问题的能力，我希望看过本篇的朋友，养成良好的编码习惯，有一个较高的问题解决能力，这样的遇到问题发生事，才会清楚这到底是谁的问题，大多数人遇到问题，陷入一个死循环，就如同VS，无法自拔，希望大家可以做一个更优秀的人。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">alldo</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://note.sungwx.com/vs-bug-001/">https://note.sungwx.com/vs-bug-001/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://note.sungwx.com" target="_blank">北冥鱼饵</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/C-C/">C/C++</a><a class="post-meta__tags" href="/tags/free/">free</a><a class="post-meta__tags" href="/tags/Visual-Studio/">Visual Studio</a><a class="post-meta__tags" href="/tags/坑/">坑</a></div><nav id="pagination"></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine@1.1.9-beta9/dist/Valine.min.js"></script><script>var notify = 'false' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'9aiW9hIdxFf2GJ5D4KECqe2e-gzGzoHsz',
  appKey:'p7MoOR8kq9s0lvmsVrC71179',
  placeholder:'Just go go',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2018 By alldo</div><div class="framework-info"><!-- span= _p('footer.driven') + ' - '--><!-- a(href='http://hexo.io')--><!--   span Hexo--><!-- span.footer-separator |--><!-- span= _p('footer.theme') + ' - '--><!-- a(href='https://github.com/Molunerfinn/hexo-theme-melody')--><!--   span Melody--></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script></body></html>